<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <title>Page Templates</title>
  <meta name="relativeRoot" content="..">
  <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
  <link href="../static/trac.css" rel="stylesheet" type="text/css">
  <link href="../static/site.css" rel="stylesheet" type="text/css">
  <script src="../static/site.js"></script>
  <script>window.onload = () => fixPage()</script>
</head>
<body id="_top">
<nav>
<div class="row">
<div class="left2">
<a href="http://third-bit.com"><img src="../static/logo.svg" alt="site logo" class="site-logo"/></a>
<a href="../"><em>Software Tools in JavaScript</em></a>
</div>
<div class="right2">
<div class="dropdown">
<span class="navtitle">▿ Sections</span>
<div class="dropdown-content" id="Sections">
</div>
</div>
<div class="dropdown">
<span class="navtitle">▿ Chapters</span>
<div class="dropdown-content" id="Chapters">
<a href="../systems-programming/"><span class="nowrap">Systems Programming</span></a>
<br/><a href="../unit-test/"><span class="nowrap">Unit Testing</span></a>
<br/><a href="../file-backup/"><span class="nowrap">File Backup</span></a>
<br/><a href="../style-checker/"><span class="nowrap">Style Checker</span></a>
<br/><a href="../code-generator/"><span class="nowrap">Code Generator</span></a>
<br/><a href="../page-templates/"><span class="nowrap">Page Templates</span></a>
<br/><a href="../module-loader/"><span class="nowrap">Module Loader</span></a>
<br/><a href="../module-bundler/"><span class="nowrap">Module Bundler</span></a>
<br/><a href="../layout-engine/"><span class="nowrap">Layout Engine</span></a>
<br/><a href="../text-editor/"><span class="nowrap">Text Editor</span></a>
<br/><a href="../doc-generator/"><span class="nowrap">Documentation Generator</span></a>
<br/><a href="../http-server/"><span class="nowrap">HTTP Server</span></a>
<br/><a href="../tabular-data/"><span class="nowrap">Tabular Data</span></a>
<br/><a href="../build-manager/"><span class="nowrap">Build Manager</span></a>
<br/><a href="../package-manager/"><span class="nowrap">Package Manager</span></a>
</div>
</div>
<div class="dropdown">
<span class="navtitle">▿ Appendices</span>
<div class="dropdown-content" id="Appendices">
<a href="../license/"><span class="nowrap">License</span></a>
<br/><a href="../conduct/"><span class="nowrap">Code of Conduct</span></a>
<br/><a href="../bib/"><span class="nowrap">Bibliography</span></a>
<br/><a href="../links/"><span class="nowrap">Links</span></a>
</div>
</div>
</div>
</div>
</nav>
  <main>
  <h1>Page Templates</h1>
<ul>
<li>
<p>Goal: expand HTML templates to create web pages.</p>
<ul>
<li>Option 1: put JavaScript directly in the page like <a href="https://ejs.co/">EJS</a></li>
<li>Option 2: use a mini-language like <a href="https://jekyllrb.com/">Jekyll</a></li>
<li>Option 3: use specially-named attributes in HTML</li>
</ul>
</li>
<li>
<p>We'll use Option 3 because it saves us writing a parser, and because it's unusual</p>
</li>
<li>
<p>Design:</p>
<ul>
<li>Walk the [DOM][dom] to find nodes with special attributes</li>
<li>&quot;Execute&quot; the instructions in those nodes to generate text</li>
<li>Save other text as-is</li>
</ul>
</li>
<li>
<p>What will a templated page look like?</p>
</li>
</ul>
<pre title="input-loop.html"><code class="language-html"><p>Expect three items</p>
<ul>
  <li q-loop="item:names"><span q-var="item"/></li>
</ul>
</code></pre>
<h2 id="how-can-we-transform-templates%3F-%7B%23transform-templates%7D">How can we transform templates? {#transform-templates}</h2>
<ul>
<li>How will we transform it?
<ul>
<li>Take a template, an output stream, and some variables (e.g., from [YAML][yaml] header)</li>
<li>Pass values in as an object</li>
</ul>
</li>
</ul>
<pre title="example-call.js"><code class="language-js">const variables = {
  "names": ["Johnson", "Vaughan", "Jackson"]
}
const dom = readHtml('template.html')
const expander = new Expander(dom, vars)
expander.walk()
console.log(expander.result)
</code></pre>
<ul>
<li>What will it generate?</li>
</ul>
<pre title="output-loop.html"><code class="language-html"><p>Expect three items</p>
<ul>
  <li>Johnson</li>
  <li>Vaughan</li>
  <li>Jackson</li>
</ul>
</code></pre>
<h2 id="how-can-we-keep-track-of-values%3F-%7B%23values%7D">How can we keep track of values? {#values}</h2>
<ul>
<li>Need a way to keep track of variables' values</li>
<li>Maintain a stack of lookup tables
<ul>
<li>Each [stack frame][stack-frame] is an object</li>
<li><code>Env.find</code> looks up the list of stack frames</li>
<li>This is [dynamic scoping][dynamic-scoping] not [lexical scoping][lexical-scoping]</li>
</ul>
</li>
</ul>
<pre title="env.js"><code class="language-js">class Env {
  constructor (initial) {
    this.stack = []
    this.push(Object.assign({}, initial))
  }

  push (frame) {
    this.stack.push(frame)
  }

  pop () {
    this.stack.pop()
  }

  find (name) {
    for (let i = this.stack.length - 1; i >= 0; i--) {
      if (name in this.stack[i]) {
        return this.stack[i][name]
      }
    }
    return undefined
  }

  toString () {
    return JSON.stringify(this.stack)
  }
}

module.exports = Env
</code></pre>
<ul>
<li>Structure is defined by our HTML parser</li>
<li>Handle nodes with and without children using the [Visitor pattern][visitor-pattern]
<ul>
<li><code>Visitor.walk()</code> without an argument assigns <code>undefined</code> to <code>node</code>, so we re-set to the root of the tree</li>
<li>Alternative designs would be build-and-run or pass in the root with every call</li>
</ul>
</li>
</ul>
<pre title="visitor.js"><code class="language-js">// Visit DOM nodes.
class Visitor {
  constructor (root) {
    this.root = root
  }

  walk (node) {
    if (node === undefined) {
      node = this.root
    }
    if (node instanceof Array) {
      for (let child of node) {
        this.walk(child)
      }
    }
    else if (node instanceof Object) {
      if (this.open(node)) {
        if ('children' in node) {
          this.walk(node.children)
        }
        this.close(node)
      }
    }
    else {
      throw new Error(`unknown node ${node}`)
    }
  }

  open (node) {
    return true
  }

  close (node) {}
}

module.exports = Visitor
</code></pre>
<h2 id="how-do-we-handle-each-type-of-node%3F-%7B%23node-handling%7D">How do we handle each type of node? {#node-handling}</h2>
<ul>
<li>What do we do with each node?
<ul>
<li>Text: copy to output</li>
<li>Node with <code>q-num</code> attribute: constant</li>
<li>Node with <code>q-var</code> attribute: look up variable and output its value</li>
<li>Node with <code>q-if</code> attribute: show content if variable is true</li>
<li>Node with <code>q-loop</code> attribute: loop over the contents of a variable
<ul>
<li>Each pass creates a new stack frame</li>
</ul>
</li>
<li>Any other node: copy to output</li>
</ul>
</li>
</ul>
<pre title="expander.js"><code class="language-js">const Visitor = require('./visitor')
const Env = require('./env')

class Expander extends Visitor {
  constructor (root, vars) {
    super(root)
    this.env = new Env(vars)
    this.result = ''
  }

  open (node) {
    let doRest = true

    if (node.type === 'text') {
      this.output(node.data)
    }

    else if (node.type !== 'tag') {
      throw new Error(`Unknown node type ${node.type}`)
    }

    else if ('q-num' in node.attribs) {
      this.showTag(node, true)
      this.output(node.attribs['q-num'])
    }

    else if ('q-var' in node.attribs) {
      this.showTag(node, true)
      this.output(this.env.find(node.attribs['q-var']))
    }

    else if ('q-if' in node.attribs) {
      doRest = this.env.find(node.attribs['q-if'])
      if (doRest) {
        this.showTag(node, true)
      }
    }

    else if ('q-loop' in node.attribs) {
      let [indexName, targetName] = node.attribs['q-loop'].split(':')
      delete node.attribs['q-loop']
      const target = this.env.find(targetName)
      for (let index of target) {
        this.env.push({[indexName]: index})
        this.walk(node)
        this.env.pop()
      }
      doRest = false
    }

    else {
      this.showTag(node, true)
    }

    return doRest
  }

  close (node) {
    if (node.type !== 'tag') {
      // do nothing
    }

    else if ('q-num' in node.attribs) {
      this.showTag(node, false)
    }

    else if ('q-var' in node.attribs) {
      this.showTag(node, false)
    }

    else if ('q-if' in node.attribs) {
      if (this.env.find(node.attribs['q-if'])) {
        this.showTag(node, false)
      }
    }

    else if ('q-loop' in node.attribs) {
      // do nothing
    }

    else {
      this.showTag(node, false)
    }
  }

  showTag (node, opening) {
    if (opening) {
      this.output(`<${node.name}`)
      for (let a in node.attribs) {
        if (!a.startsWith('q-')) {
          this.output(` ${a}="${node.attribs[a]}"`)
        }
      }
      this.output(`>`)
    }
    else {
      this.output(`</${node.name}>`)
    }
  }

  output (text) {
    this.result += (text === undefined) ? 'UNDEF' : text
  }
}

module.exports = Expander
</code></pre>
<h2 id="what-does-this-look-like-when-we-put-it-all-together%3F-%7B%23integration%7D">What does this look like when we put it all together? {#integration}</h2>
<ul>
<li>Full program loads variable definitions from a JSON file
<ul>
<li>Concatenates strings repeatedly</li>
<li>Look at more efficient approaches in the exercises</li>
</ul>
</li>
</ul>
<pre title="template.js"><code class="language-js">const fs = require('fs')
const htmlparser = require('htmlparser2')
const Expander = require('./expander')

const main = () => {
  const vars = readJSON(process.argv[2])
  const dom = readHtml(process.argv[3])
  const expander = new Expander(dom, vars)
  expander.walk()
  console.log(expander.result)
}

const readJSON = (filename) => {
  const text = fs.readFileSync(filename, 'utf-8')
  return JSON.parse(text)
}

const readHtml = (filename) => {
  const text = fs.readFileSync(filename, 'utf-8')
  return htmlparser.parseDOM(text)
}

main()
</code></pre>
<h2 id="how-can-we-test-this%3F-%7B%23testing%7D">How can we test this? {#testing}</h2>
<ul>
<li>Create a few tests</li>
<li>Variable definitions shared by all tests</li>
</ul>
<pre title="vars.json"><code class="language-json">{
  "firstVariable": "firstvalue",
  "secondVariable": "secondValue",
  "variableName": "variableValue",
  "showThis": true,
  "doNotShowThis": false,
  "names": ["Johnson", "Vaughan", "Jackson"]
}
</code></pre>
<ul>
<li>Static text should be copied over</li>
</ul>
<pre title="input-static-text.html"><code class="language-html"><html>
  <body>
    <h1>Only Static Text</h1>
    <p>This document only contains:</p>
    <ul>
      <li>static</li>
      <li>text</li>
    </ul>
  </body>
</html>
</code></pre>
<pre title="static-text.sh"><code class="language-sh">node template.js input-vars.json input-only-static-text-input.html
</code></pre>
<pre title="output-static-text.html"><code class="language-html"><html>
  <body>
    <h1>Only Static Text</h1>
    <p>This document only contains:</p>
    <ul>
      <li>static</li>
      <li>text</li>
    </ul>
  </body>
</html>
</code></pre>
<ul>
<li>Single constant should be substituted</li>
</ul>
<pre title="input-single-constant.html"><code class="language-html"><p><span q-num="123"/></p>
</code></pre>
<pre title="output-single-constant.html"><code class="language-html"><p>123</p>
</code></pre>
<ul>
<li>Single variable should be substituted</li>
</ul>
<pre title="input-single-variable.html"><code class="language-html"><p><span q-var="variableName"/></p>
</code></pre>
<pre title="output-single-variable.html"><code class="language-html"><p>variableValue</p>
</code></pre>
<ul>
<li>Expand multiple variables</li>
</ul>
<pre title="input-multiple-variables.html"><code class="language-html"><p><span q-var="firstVariable" /></p>
<p><span q-var="secondVariable" /></p>
</code></pre>
<pre title="output-multiple-variables.html"><code class="language-html"><p>firstValue</p>
<p>secondValue</p>
</code></pre>
<ul>
<li>Conditional expression</li>
</ul>
<pre title="input-conditional.html"><code class="language-html"><p q-if="showThis">This should be shown.</p>
<p q-if="doNotShowThis">This should <em>not</em> be shown.</p>
</code></pre>
<pre title="output-conditional.html"><code class="language-html"><p>This should be shown.</p>
</code></pre>
<ul>
<li>Loop</li>
</ul>
<pre title="input-loop.html"><code class="language-html"><p>Expect three items</p>
<ul>
  <li q-loop="item:names"><span q-var="item"/></li>
</ul>
</code></pre>
<pre title="output-loop.html"><code class="language-html"><p>Expect three items</p>
<ul>
  <li>Johnson</li>
  <li>Vaughan</li>
  <li>Jackson</li>
</ul>
</code></pre>
</main>
<footer>
<div class="row">
<div class="left3">
<a href="../code-generator/"><em>&laquo; Code Generator</em></a>
</div>
<div class="middle3">
<a href="../license/"><img class="footer" src="../static/cc-by.svg" alt="License" /></a>
<a href="https://github.com/gvwilson/e/"><img class="footer" src="../static/github.svg" alt="Repository" /></a>
© 2020 <a href="../authors/">The Authors</a>
</div>
<div class="right3">
<a href="../module-loader/"><em>Module Loader &raquo;</em></a>
</div>
</div>
</footer>
</body>
</html>
