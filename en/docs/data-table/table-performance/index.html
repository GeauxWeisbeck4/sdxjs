<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="stylesheet" href="../../mccole.css">
  <link rel="stylesheet" href="../../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design by Example</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../../logo.svg" alt="site logo" width="10%" />
  <a href="../../">Software Design by Example</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div id="printable" class="column bordered">
        <main>
	  
  <h1>Software Design by Example</h1>
  <h2><em>a tool-based introduction with JavaScript</em></h2>


          

	  
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


          import assert from 'assert'
import microtime from 'microtime'
import sizeof from 'object-sizeof'
import yaml from 'js-yaml'

import { buildRows, buildCols } from './build.js'

// [main]
const RANGE = 3

const main = () => {
  const nRows = parseInt(process.argv[2])
  const nCols = parseInt(process.argv[3])
  const filterPerSelect = parseFloat(process.argv[4])

  const labels = [...Array(nCols).keys()].map(i => `label_${i + 1}`)
  const someLabels = labels.slice(0, Math.floor(labels.length / 2))
  assert(someLabels.length > 0,
    'Must have some labels for select (array too short)')

  const [rowTable, rowSize, rowHeap] = memory(buildRows, nRows, labels)
  const [colTable, colSize, colHeap] = memory(buildCols, nRows, labels)

  const rowFilterTime =
    time(rowFilter, rowTable,
      row => ((row.label_1 % RANGE) === 0))
  const rowSelectTime =
    time(rowSelect, rowTable, someLabels)
  const colFilterTime =
    time(colFilter, colTable,
      (table, iR) => ((table.label_1[iR] % RANGE) === 0))
  const colSelectTime =
    time(colSelect, colTable, someLabels)

  const ratio = calculateRatio(filterPerSelect,
    rowFilterTime, rowSelectTime,
    colFilterTime, colSelectTime)

  const result = {
    nRows,
    nCols,
    filterPerSelect,
    rowSize,
    rowHeap,
    colSize,
    colHeap,
    rowFilterTime,
    rowSelectTime,
    colFilterTime,
    colSelectTime,
    ratio
  }
  console.log(yaml.safeDump(result))
}
// [/main]

// [measure]
const memory = (func, ...params) => {
  const before = process.memoryUsage()
  const result = func(...params)
  const after = process.memoryUsage()
  const heap = after.heapUsed - before.heapUsed
  const size = sizeof(result)
  return [result, size, heap]
}

const time = (func, ...params) => {
  const before = microtime.now()
  func(...params)
  const after = microtime.now()
  return after - before
}

const calculateRatio = (f2S, rFilterT, rSelectT, cFilterT, cSelectT) => {
  return ((f2S * rFilterT) + rSelectT) / ((f2S * cFilterT) + cSelectT)
}
// [/measure]

// [operate-rows]
const rowFilter = (table, func) => {
  return table.filter(row => func(row))
}

const rowSelect = (table, toKeep) => {
  return table.map(row => {
    const newRow = {}
    toKeep.forEach(label => {
      newRow[label] = row[label]
    })
    return newRow
  })
}
// [/operate-rows]

// [operate-cols]
const colFilter = (table, func) => {
  const result = {}
  const labels = Object.keys(result)
  labels.forEach(label => {
    result[label] = []
  })
  for (let iR = 0; iR < table.label_1.length; iR += 1) {
    if (func(table, iR)) {
      labels.forEach(label => {
        result[label].push(table[label][iR])
      })
    }
  }
  return result
}

const colSelect = (table, toKeep) => {
  const result = {}
  toKeep.forEach(label => {
    result[label] = table[label]
  })
  return result
}
// [/operate-cols]

main()

        </main>
      </div>
    </div>
  </body>
</html>
