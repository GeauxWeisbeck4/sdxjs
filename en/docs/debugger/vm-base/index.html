<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="stylesheet" href="../../mccole.css">
  <link rel="stylesheet" href="../../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design by Example</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../../logo.svg" alt="site logo" width="10%" />
  <a href="../../">Software Design by Example</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../../links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="../../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div id="printable" class="column bordered">
        <main>
	  
  <h1>Software Design by Example</h1>
  <h2><em>a tool-based introduction with JavaScript</em></h2>


          

	  
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


          import assert from 'assert'

class VirtualMachineBase {
  constructor (program) {
    this.program = this.compile(program)
    this.prefix = '>>'
  }

  compile (lines) {
    const text = lines
      .map(line => line.trim())
      .filter(line => (line.length > 0) && !line.startsWith('//'))
      .join('\n')
    return JSON.parse(text)
  }

  run () {
    this.env = {}
    this.runAll(this.program)
  }

  runAll (commands) {
    commands.forEach(command => this.exec(command))
  }

  exec (command) {
    const [op, ...args] = command
    assert(op in this,
      `Unknown op "${op}"`)
    return this[op](args)
  }

  // [skip]
  // [add]
  add (args) {
    this.checkOp('add', 2, args)
    const left = this.exec(args[0])
    const right = this.exec(args[1])
    return left + right
  }
  // [/add]

  append (args) {
    this.checkOp('append', 2, args)
    this.checkArray('append', args[0])
    const val = this.exec(args[1])
    this.env[args[0]].push(val)
  }

  data (args) {
    return args
  }

  defA (args) {
    this.checkOp('defA', 2, args)
    const [name, data] = args
    this.env[name] = this.exec(data)
  }

  // [defV]
  defV (args) {
    this.checkOp('defV', 2, args)
    const [name, value] = args
    this.env[name] = this.exec(value)
  }
  // [/defV]

  getA (args) {
    this.checkOp('getA', 2, args)
    this.checkArray('getA', args[0])
    const index = this.exec(args[1])
    this.checkIndex('getA', args[0], index)
    return this.env[args[0]][index]
  }

  getV (args) {
    this.checkOp('getV', 1, args)
    this.checkName('getV', args[0])
    return this.env[args[0]]
  }

  gt (args) {
    this.checkOp('gt', 2, args)
    const left = this.exec(args[0])
    const right = this.exec(args[1])
    return left > right
  }

  len (args) {
    this.checkOp('len', 1, args)
    this.checkArray('len', args[0])
    return this.env[args[0]].length
  }

  lt (args) {
    this.checkOp('lt', 2, args)
    const left = this.exec(args[0])
    const right = this.exec(args[1])
    return left < right
  }

  // [loop]
  loop (args) {
    this.checkBody('loop', 1, args)
    const body = args.slice(1)
    while (this.exec(args[0])) {
      this.runAll(body)
    }
  }
  // [/loop]

  num (args) {
    this.checkOp('num', 1, args)
    assert(typeof args[0] === 'number',
      `Non-numeric value for "num": "${args[0]}"`)
    return args[0]
  }

  print (args) {
    this.checkOp('print', 1, args)
    const val = this.exec(args[0])
    this.message(this.prefix, val)
  }

  setA (args) {
    this.checkOp('setA', 3, args)
    this.checkArray('setA', args[0])
    const index = this.exec(args[1])
    this.checkIndex('setA', args[0], index)
    const value = this.exec(args[2])
    this.env[args[0]][index] = value
  }

  setV (args) {
    this.checkOp('setV', 2, args)
    this.checkName('setV', args[0])
    this.env[args[0]] = this.exec(args[1])
  }

  test (args) {
    this.checkBody('test', 1, args)
    const condition = this.exec(args[0])
    if (condition) {
      const body = args.slice(1)
      this.runAll(body)
    }
  }

  // [checkArray]
  checkArray (op, name) {
    this.checkName(op, name)
    const array = this.env[name]
    assert(Array.isArray(array),
      `Variable "${name}" used in "${op}" is not array`)
  }
  // [/checkArray]

  checkBody (op, minimum, args) {
    assert(args.length >= minimum,
      `Badly-formatted operation ${op}: ${JSON.stringify(args)}`)
  }

  checkIndex (op, name, index) {
    this.checkArray(op, name)
    assert((0 <= index) && (index < this.env[name].length),
      `Index "${index}" out of bounds for array "${name}"`)
  }

  checkName (op, name) {
    assert(name in this.env,
      `Unknown name "${name}" for operation "${op}"`)
  }

  checkOp (op, expected, args) {
    assert(args.length === expected,
      `Badly-formatted operation ${op}: ${JSON.stringify(args)}`)
  }

  message (prefix, val) {
    console.log(prefix, val)
  }
  // [/skip]
}

export default VirtualMachineBase

        </main>
      </div>
    </div>
  </body>
</html>
