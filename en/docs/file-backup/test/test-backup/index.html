<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico">
  <link rel="stylesheet" href="../../../mccole.css">
  <link rel="stylesheet" href="../../../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design by Example</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../../../logo.svg" alt="site logo" width="10%" />
  <a href="../../../">Software Design by Example</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../../../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../../../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../../../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../../../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../../../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../../../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../../../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../../../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../../../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../../../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../../../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../../../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../../../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../../../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../../../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../../../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../../../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../../../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../../../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../../../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../../../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../../../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../../../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../../../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../../../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../../../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../../../links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="../../../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div id="printable" class="column bordered">
        <main>
	  
  <h1>Software Design by Example</h1>
  <h2><em>a tool-based introduction with JavaScript</em></h2>


          

	  
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


          import assert from 'assert'
import fs from 'fs-extra-promise'
import glob from 'glob-promise'
import mock from 'mock-fs'
import crypto from 'crypto'

// [fixtures]
import backup from '../backup.js'

const hashString = (data) => {
  const hasher = crypto.createHash('sha1').setEncoding('hex')
  hasher.write(data)
  hasher.end()
  return hasher.read()
}

const Contents = {
  aaa: 'AAA',
  bbb: 'BBB',
  ccc: 'CCC'
}

const Hashes = Object.keys(Contents).reduce((obj, key) => {
  obj[key] = hashString(Contents[key])
  return obj
}, {})

const Fixture = {
  source: {
    'alpha.txt': Contents.aaa,
    'beta.txt': Contents.bbb,
    gamma: {
      'delta.txt': Contents.ccc
    }
  },
  backup: {}
}

const InitialBackups = Object.keys(Hashes).reduce((set, filename) => {
  set.add(`backup/${Hashes[filename]}.bck`)
  return set
}, new Set())
// [/fixtures]

// [tests]
describe('check entire backup process', () => {
  beforeEach(() => {
    mock(Fixture)
  })

  afterEach(() => {
    mock.restore()
  })

  it('creates an initial CSV manifest', async () => {
    await backup('source', 'backup', 0)

    assert.strictEqual((await glob('backup/*')).length, 4,
      'Expected 4 files')

    const actualBackups = new Set(await glob('backup/*.bck'))
    assert.deepStrictEqual(actualBackups, InitialBackups,
      'Expected 3 backup files')

    const actualManifests = await glob('backup/*.csv')
    assert.deepStrictEqual(actualManifests, ['backup/0000000000.csv'],
      'Expected one manifest')
  })

  it('does not duplicate files unnecessarily', async () => {
    await backup('source', 'backup', 0)
    assert.strictEqual((await glob('backup/*')).length, 4,
      'Expected 4 files after first backup')

    await backup('source', 'backup', 1)
    assert.strictEqual((await glob('backup/*')).length, 5,
      'Expected 5 files after second backup')
    const actualBackups = new Set(await glob('backup/*.bck'))
    assert.deepStrictEqual(actualBackups, InitialBackups,
      'Expected 3 backup files after second backup')

    const actualManifests = (await glob('backup/*.csv')).sort()
    assert.deepStrictEqual(actualManifests,
      ['backup/0000000000.csv', 'backup/0000000001.csv'],
      'Expected two manifests')
  })

  it('adds a file as needed', async () => {
    await backup('source', 'backup', 0)
    assert.strictEqual((await glob('backup/*')).length, 4,
      'Expected 4 files after first backup')

    await fs.writeFileAsync('source/newfile.txt', 'NNN')
    const hashOfNewFile = hashString('NNN')

    await backup('source', 'backup', 1)
    assert.strictEqual((await glob('backup/*')).length, 6,
      'Expected 6 files after second backup')
    const expected = new Set(InitialBackups)
      .add(`backup/${hashOfNewFile}.bck`)
    const actualBackups = new Set(await glob('backup/*.bck'))
    assert.deepStrictEqual(actualBackups, expected,
      'Expected 4 backup files after second backup')

    const actualManifests = (await glob('backup/*.csv')).sort()
    assert.deepStrictEqual(actualManifests,
      ['backup/0000000000.csv', 'backup/0000000001.csv'],
      'Expected two manifests')
  })
})
// [/tests]

        </main>
      </div>
    </div>
  </body>
</html>
