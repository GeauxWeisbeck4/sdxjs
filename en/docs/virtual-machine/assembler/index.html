<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="stylesheet" href="../../mccole.css">
  <link rel="stylesheet" href="../../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design by Example</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../../logo.svg" alt="site logo" width="10%" />
  <a href="../../">Software Design by Example</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../../links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="../../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div id="printable" class="column bordered">
        <main>
	  
  <h1>Software Design by Example</h1>
  <h2><em>a tool-based introduction with JavaScript</em></h2>


          

	  
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


          import assert from 'assert'

import {
  OPS,
  OP_SHIFT,
  OP_WIDTH,
  NUM_REG
} from './architecture.js'

class Assembler {
  // [assemble]
  assemble (lines) {
    lines = this.cleanLines(lines)
    const labels = this.findLabels(lines)
    const instructions = lines.filter(line => !this.isLabel(line))
    const compiled = instructions.map(instr => this.compile(instr, labels))
    const program = this.instructionsToText(compiled)
    return program
  }

  cleanLines (lines) {
    return lines
      .map(line => line.trim())
      .filter(line => line.length > 0)
      .filter(line => !this.isComment(line))
  }

  isComment (line) {
    return line.startsWith('#')
  }
  // [/assemble]

  // [find-labels]
  findLabels (lines) {
    const result = {}
    let index = 0
    lines.forEach(line => {
      if (this.isLabel(line)) {
        const label = line.slice(0, -1)
        assert(!(label in result),
          `Duplicate label ${label}`)
        result[label] = index
      } else {
        index += 1
      }
    })
    return result
  }

  isLabel (line) {
    return line.endsWith(':')
  }
  // [/find-labels]

  // [compile]
  compile (instruction, labels) {
    const [op, ...args] = instruction.split(/\s+/)
    assert(op in OPS,
      `Unknown operation "${op}"`)
    let result = 0
    switch (OPS[op].fmt) {
      case '--':
        result = this.combine(
          OPS[op].code
        )
        break
      case 'r-':
        result = this.combine(
          this.register(args[0]),
          OPS[op].code
        )
        break
      case 'rr':
        result = this.combine(
          this.register(args[1]),
          this.register(args[0]),
          OPS[op].code
        )
        break
      case 'rv':
        result = this.combine(
          this.value(args[1], labels),
          this.register(args[0]),
          OPS[op].code
        )
        break
      default:
        assert(false,
          `Unknown instruction format ${OPS[op].fmt}`)
    }
    return result
  }
  // [/compile]

  // [combine]
  combine (...args) {
    assert(args.length > 0,
      'Cannot combine no arguments')
    let result = 0
    for (const a of args) {
      result <<= OP_SHIFT
      result |= a
    }
    return result
  }
  // [/combine]

  // [utilities]
  instructionsToText (program) {
    return program.map(op => op.toString(16).padStart(OP_WIDTH, '0'))
  }

  register (token) {
    assert(token[0] === 'R',
      `Register "${token}" does not start with 'R'`)
    const r = parseInt(token.slice(1))
    assert((0 <= r) && (r < NUM_REG),
      `Illegal register ${token}`)
    return r
  }

  value (token, labels) {
    if (token[0] !== '@') {
      return parseInt(token)
    }
    const labelName = token.slice(1)
    assert(labelName in labels,
      `Unknown label "${token}"`)
    return labels[labelName]
  }
  // [/utilities]
}

export default Assembler

        </main>
      </div>
    </div>
  </body>
</html>
